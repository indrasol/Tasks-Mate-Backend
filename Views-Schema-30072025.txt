-- View: public.project_stats_view

-- DROP VIEW public.project_stats_view;

CREATE OR REPLACE VIEW public.project_stats_view AS
 SELECT p.project_id,
    count(t.*) AS tasks_total,
    count(*) FILTER (WHERE t.status = 'completed'::task_status_enum) AS tasks_completed,
        CASE
            WHEN count(t.*) = 0 THEN 0::numeric
            ELSE round(100.0 * count(*) FILTER (WHERE t.status = 'completed'::task_status_enum)::numeric / count(t.*)::numeric, 1)
        END AS progress_percent
   FROM projects p
     LEFT JOIN tasks t USING (project_id)
  GROUP BY p.project_id;

ALTER TABLE public.project_stats_view
    OWNER TO postgres;
